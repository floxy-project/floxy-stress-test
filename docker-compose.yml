version: '3.8'

services:
  floxy-stress-pg:
    image: postgres:17-alpine
    container_name: floxy-stress-pg
    environment:
      POSTGRES_USER: floxy
      POSTGRES_PASSWORD: password
      POSTGRES_MULTIPLE_DATABASES: floxy
      PGDATA: /var/lib/postgresql/data/pgdata
    command: -c config_file=/etc/postgresql.conf
    volumes:
      - "./postgres_initdb:/docker-entrypoint-initdb.d"
      - "./postgresql.conf:/etc/postgresql.conf"
    ports:
      - "5432:5432"
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U floxy -d floxy"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 10s

  floxy-stress-toxiproxy:
    image: ghcr.io/shopify/toxiproxy:latest
    container_name: floxy-stress-toxiproxy
    ports:
      - "8474:8474"
      - "6432:6432"
    volumes:
      - ./toxiproxy.json:/config/toxiproxy.json
    command: -host=0.0.0.0 -config /config/toxiproxy.json
    healthcheck:
      test: ["CMD", "/toxiproxy-cli", "list"]
      interval: 2s
      timeout: 2s
      retries: 10
      start_period: 5s
    depends_on:
      floxy-stress-pg:
        condition: service_healthy

  floxy-stress-tester:
    build:
      context: .
    container_name: floxy-stress-tester
    restart: no
    environment:
      DB_HOST: floxy-stress-pg
      DB_PORT: 5432
      DB_NAME: floxy
      DB_USER: floxy
      DB_PASSWORD: password
      USE_TOXIPROXY: true
      TOXIPROXY_HOST: floxy-stress-toxiproxy
      TOXIPROXY_API_PORT: 8474
      TOXIPROXY_PORT: 6432
      REPEAT: 100
    depends_on:
      floxy-stress-toxiproxy:
        condition: service_healthy
      floxy-stress-pg:
        condition: service_healthy

  floxy-stress-ui:
    image: rom8726/floxy-ui:latest
    container_name: floxy-stress-ui
    restart: always
    environment:
      DB_HOST: floxy-stress-pg
      DB_PORT: 5432
      DB_NAME: floxy
      DB_USER: floxy
      DB_PASSWORD: password
      NODE_ENV: production
    ports:
      - "3001:3001"
    depends_on:
      floxy-stress-pg:
        condition: service_healthy
